select
  pr.scode ApplicationUniqueId,
  t.scode TenantID,
  p.scode PropertyID,
  p.saddr1 PropertyName,
  u.scode Unit#,
  CONVERT(varchar(10), t.dtleasefrom, 101) LeaseStartDate,
  CONVERT(varchar(10), t.dtleaseto, 101) LeaseEndDate,
  ts.status TenantStatus,
  t.srent RentAmount,
  CONVERT(varchar(10), t.dtmovein, 101) MoveInDate,
  CONVERT(varchar(10), t.dtmoveout, 101) MoveDateOut,
  OPBal.OPtotal OpenDepositBalance,
  COLBal.coltotal ClosedDepositBalance1,
  UnpaidRentTotal.unpaidrent UnpaidRentAtMoveOut,
  UnpaidOtherTotal.unpaidotheramt OtherUnpaidAmtAtMoveOut,
  AmtPaidAfterMoveout.ReceiptAfterDA AmountPaidByTenantAtMoveOut,
  new.total unpaidrentamount
from
  property p
  inner join unit u on u.hproperty = p.hmy
  inner join tenant t on t.hproperty = p.hmy
  and t.hunit = u.hmy
  inner join prospect pr on pr.htenant = t.hmyperson
  left join tenstatus ts on ts.istatus = t.istatus
  left join (
    select
      tr.hperson personhmy,
      sum(tr.stotalamount) OPtotal
    from
      trans tr
      inner join tenant t on t.hmyperson = tr.hperson
      and tr.hretentionacct = 37
      and tr.stotalamount > 0
    group by
      tr.hperson
  ) OPBal on OPBal.personhmy = t.hmyperson
  left join (
    select
      tr.hperson personhmy,
      sum(tr.stotalamount - tr.samountpaid) coltotal
    from
      tenant t
      inner join trans tr on tr.hperson = t.hmyperson
      and tr.bopen = -1
      and t.istatus = 1
      and t.bmovedout = -1
      and tr.itype = 7
    group by
      tr.hperson
  ) COLBal on COLBal.personhmy = t.hmyperson
  left join (
    select
      tr.hperson personhmy,
      sum(tr.stotalamount - tr.samountpaid) unpaidrent
    from
      tenant t
      inner join trans tr on tr.hperson = t.hmyperson
      and tr.bopen = -1
      and t.istatus = 1
      and tr.hretentionacct in (52, 75)
    group by
      tr.hperson
  ) UnpaidRentTotal on UnpaidRentTotal.personhmy = t.hmyperson
  left join (
    select
      tr.hperson personhmy,
      sum(tr.stotalamount - tr.samountpaid) unpaidotheramt
    from
      tenant t
      inner join trans tr on tr.hperson = t.hmyperson
      and tr.bopen = -1
      and t.istatus = 1
      and tr.hretentionacct not in (52, 75)
      and tr.itype = 7
    group by
      tr.hperson
  ) UnpaidOtherTotal on UnpaidOtherTotal.personhmy = t.hmyperson
  left join (
    select
      t.hmyperson personhmy,
      sum(tr.stotalamount) ReceiptAfterDA
    from
      tenant t
      inner join tenant_history th on th.htent = t.hmyperson
      and th.sevent = 'Deposit Accounting'
      and t.bmovedout = -1
      and t.istatus = 1
      inner join trans tr on tr.hperson = t.hmyperson
      and tr.itype = 6
      and tr.sdatecreated > th.dtoccurred
    group by
      t.hmyperson
  ) AmtPaidAfterMoveout on AmtPaidAfterMoveout.personhmy = t.hmyperson
  left join trans tr on tr.hperson=t.hmyperson
  left join (SELECT Sum(unpaidcharge.sum1) total,unpaidcharge.charge unpaidrentcharge
FROM   (
              SELECT Sum(tr1.stotalamount) sum1,tr1.hmy charge
              FROM   trans tr1
              WHERE  tr1.hmy IN
                     (
                            SELECT hchkorchg
                            FROM   detail
                            WHERE  hinvorrec IN
                                   (
                                              SELECT     tr2.hmy
                                              FROM       trans tr2
                                              INNER JOIN tenant t
                                              ON         t.hmyperson=tr2.hperson
                                              INNER JOIN tenant_history th
                                              ON         th.htent=t.hmyperson
                                              AND        th.sevent='Deposit Accounting'
                                     		
                                              WHERE      CAST(CAST(tr2.sdatecreated AS varchar(19)) AS datetime)=
                                     CAST(CAST(th.dtoccurred AS varchar(19)) AS datetime)
                                              AND        tr2.itype=6
                                              AND        tr2.hperson=33732 )
                            AND    hchkorchg NOT IN
                                   (
                                              SELECT     tr3.hmy
                                              FROM       trans tr3
                                              INNER JOIN tenant t
                                              ON         t.hmyperson=tr3.hperson
                                              INNER JOIN tenant_history th
                                              ON         th.htent=t.hmyperson
                                              AND        th.sevent='Deposit Accounting'
                                              WHERE      CAST(CAST(tr3.sdatecreated AS varchar(19)) AS datetime)=
                                     CAST(CAST(th.dtoccurred AS varchar(19)) AS datetime))
                            AND    tr1.itype=7
                            AND    tr1.hperson IN
                                   (
                                          SELECT hmyperson
                                          FROM   tenant
                                          WHERE  scode='t0012692'
                                          AND    istatus=1)
                    		and tr1.hretentionacct=52)
  group by tr1.hmy
                            UNION
                            SELECT stotalamount sum1,hmy charge
                            FROM   trans
                            WHERE  bopen=-1
                            AND    hperson=33732
                            AND    samountpaid=0 and hretentionacct=52 group by hmy,stotalamount) unpaidcharge 
             group by unpaidcharge.charge) new on new.unpaidrentcharge = tr.hmy
where
  --p.ityperes = 1
  --and year(p.dtcreated) >= 2017
  --and isnull(p.binactive, 0) = 0
  t.scode='t0012692'
group by
  p.scode,
  p.saddr1,
  u.scode,
  pr.scode,
  t.scode,
  t.dtmovein,
  t.dtleasefrom,
  t.dtleaseto,
  t.dtmoveout,
  ts.status,
  t.srent,
  COLBal.coltotal,
  OPBal.OPtotal,
  UnpaidRentTotal.unpaidrent,
  UnpaidOtherTotal.unpaidotheramt,
  t.istatus,
  AmtPaidAfterMoveout.ReceiptAfterDA,
  new.total
  
  
